<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Test - Navikinder</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f0f0f0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 Push Notification Test</h1>
        
        <div id="status" class="status">Checking environment...</div>
        
        <div style="margin: 20px 0;">
            <button onclick="checkEnvironment()">1. Check Environment</button>
            <button onclick="registerSW()">2. Register SW</button>
            <button onclick="requestPermission()">3. Request Permission</button>
            <button onclick="subscribePush()">4. Subscribe to Push</button>
            <button onclick="testLocalNotification()">5. Test Local Notification</button>
            <button onclick="sendTestPush()">6. Send Test Push</button>
        </div>
        
        <h3>Environment Info:</h3>
        <div id="envInfo" class="log"></div>
        
        <h3>Debug Log:</h3>
        <div id="debugLog" class="log"></div>
        
        <h3>Subscription Data:</h3>
        <div id="subData" class="log" style="word-break: break-all;"></div>
    </div>

    <script>
        // YOUR VAPID PUBLIC KEY - UPDATED WITH YOUR ACTUAL KEY
        const VAPID_PUBLIC_KEY = 'BDo43wyOeBiN7qfRTNT5HCC-YuFsmLom19mO_duxDRvtE-P9ewegc51UaBQPH9ZArr51oS6kp8ltNdWy2WU9ZkU';
        
        let swRegistration = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        async function checkEnvironment() {
            log('Checking environment...');
            const envInfo = document.getElementById('envInfo');
            
            const info = {
                'Service Worker': 'serviceWorker' in navigator ? '✅ Supported' : '❌ Not supported',
                'Push API': 'PushManager' in window ? '✅ Supported' : '❌ Not supported',
                'Notification API': 'Notification' in window ? '✅ Supported' : '❌ Not supported',
                'Permission': typeof Notification !== 'undefined' ? Notification.permission : 'N/A',
                'User Agent': navigator.userAgent.includes('iPhone') ? '📱 iOS Device' : '💻 Other',
                'Standalone': window.matchMedia('(display-mode: standalone)').matches ? '✅ PWA Mode' : '❌ Browser Mode',
                'Protocol': location.protocol === 'https:' ? '✅ HTTPS' : '❌ Not HTTPS'
            };
            
            envInfo.innerHTML = Object.entries(info)
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                .join('');
                
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`Found ${registrations.length} service worker registration(s)`);
                
                for (const reg of registrations) {
                    log(`SW Scope: ${reg.scope}`);
                    if (reg.active) log(`Active SW State: ${reg.active.state}`);
                    if (reg.waiting) log(`Waiting SW State: ${reg.waiting.state}`);
                    if (reg.installing) log(`Installing SW State: ${reg.installing.state}`);
                }
            }
            
            updateStatus('Environment check complete', 'success');
        }
        
        async function registerSW() {
            try {
                log('Registering service worker...');
                
                // First unregister any existing SW
                const existing = await navigator.serviceWorker.getRegistrations();
                for (const reg of existing) {
                    await reg.unregister();
                    log('Unregistered existing SW');
                }
                
                // Register new SW
                const registration = await navigator.serviceWorker.register('/sw.js');
                swRegistration = registration;
                
                log('Service worker registered successfully');
                
                // Wait for it to be ready
                await navigator.serviceWorker.ready;
                log('Service worker is ready');
                
                updateStatus('Service Worker registered', 'success');
            } catch (error) {
                log(`SW registration failed: ${error.message}`, 'error');
                updateStatus('SW registration failed', 'error');
            }
        }
        
        async function requestPermission() {
            try {
                log('Requesting notification permission...');
                const permission = await Notification.requestPermission();
                log(`Permission result: ${permission}`);
                
                if (permission === 'granted') {
                    updateStatus('Permission granted!', 'success');
                    
                    // Test immediate notification
                    new Notification('Permission Test', {
                        body: 'Notifications are working!',
                        icon: '/navikinder-logo-256.png'
                    });
                } else {
                    updateStatus(`Permission ${permission}`, 'warning');
                }
            } catch (error) {
                log(`Permission error: ${error.message}`, 'error');
                updateStatus('Permission request failed', 'error');
            }
        }
        
        async function subscribePush() {
            try {
                log('Starting push subscription...');
                
                if (!swRegistration) {
                    await registerSW();
                }
                
                const registration = await navigator.serviceWorker.ready;
                
                // Check existing subscription
                let subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    log('Found existing subscription, unsubscribing...');
                    await subscription.unsubscribe();
                }
                
                // Subscribe with VAPID key
                log('Creating new subscription...');
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                log('Subscription created successfully!');
                
                // Display subscription details
                const subData = {
                    endpoint: subscription.endpoint,
                    keys: {
                        p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
                        auth: arrayBufferToBase64(subscription.getKey('auth'))
                    }
                };
                
                document.getElementById('subData').innerHTML = 
                    '<pre>' + JSON.stringify(subData, null, 2) + '</pre>';
                
                log('Subscription endpoint: ' + subscription.endpoint.substring(0, 50) + '...');
                updateStatus('Push subscription successful!', 'success');
                
                // Save to your database here
                log('TODO: Save subscription to database');
                
            } catch (error) {
                log(`Subscription error: ${error.message}`, 'error');
                updateStatus('Subscription failed', 'error');
            }
        }
        
        async function testLocalNotification() {
            try {
                log('Sending test notification to service worker...');
                
                const registration = await navigator.serviceWorker.ready;
                if (registration.active) {
                    registration.active.postMessage({ type: 'TEST_NOTIFICATION' });
                    log('Test message sent to service worker');
                    updateStatus('Test sent - check for notification', 'success');
                } else {
                    log('No active service worker found');
                    updateStatus('No active service worker', 'error');
                }
            } catch (error) {
                log(`Test error: ${error.message}`, 'error');
                updateStatus('Test failed', 'error');
            }
        }
        
        async function sendTestPush() {
            try {
                log('Sending test push via server...');
                
                const response = await fetch('https://nqrtkgxqgenflhpijpxa.supabase.co/functions/v1/test-push', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcnRrZ3hxZ2VuZmxocGlqcHhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2OTY4NzcsImV4cCI6MjA2OTI3Mjg3N30.YFkNt9Zz3pG8uVQj6UmsTCWuOswW7wDRSS5GGmELaXI',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                log('Server response: ' + JSON.stringify(result));
                
                if (result.success) {
                    updateStatus('Push sent from server!', 'success');
                } else {
                    updateStatus('Push failed: ' + result.error, 'error');
                }
            } catch (error) {
                log(`Server push error: ${error.message}`, 'error');
                updateStatus('Server push failed', 'error');
            }
        }
        
        // Helper functions
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        // Check environment on load
        window.addEventListener('load', checkEnvironment);
        
        // Listen for SW messages
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                log('Received message from SW: ' + JSON.stringify(event.data));
            });
        }
    </script>
</body>
</html>